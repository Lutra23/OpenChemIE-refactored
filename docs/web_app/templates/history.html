<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史记录 - OpenChemIE</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .task-card {
            transition: transform 0.2s ease;
            border-left: 4px solid #dee2e6;
        }
        .task-card:hover {
            transform: translateY(-2px);
        }
        .task-card.completed {
            border-left-color: #28a745;
        }
        .task-card.processing {
            border-left-color: #007bff;
        }
        .task-card.error {
            border-left-color: #dc3545;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .empty-state {
            padding: 60px 20px;
            text-align: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-flask me-2"></i>
                OpenChemIE 提取工具
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>返回首页
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-history me-2"></i>
                历史记录
            </h2>
            <div>
                <button class="btn btn-outline-danger" onclick="clearHistory()">
                    <i class="fas fa-trash me-2"></i>
                    清理历史
                </button>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>
                    新建任务
                </a>
            </div>
        </div>

        <!-- 任务列表 -->
        {% if tasks %}
            <div class="row">
                {% for task_id, task_info in tasks %}
                <div class="col-12 mb-3">
                    <div class="card task-card {{ task_info.status }}">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center mb-2">
                                        <h5 class="card-title mb-0 me-3">
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                            {{ task_info.filename }}
                                        </h5>
                                        {% if task_info.status == 'completed' %}
                                            <span class="badge bg-success status-badge">已完成</span>
                                        {% elif task_info.status == 'processing' %}
                                            <span class="badge bg-primary status-badge">处理中</span>
                                        {% elif task_info.status == 'pending' %}
                                            <span class="badge bg-info status-badge">等待中</span>
                                        {% elif task_info.status == 'error' %}
                                            <span class="badge bg-danger status-badge">出错</span>
                                        {% else %}
                                            <span class="badge bg-secondary status-badge">{{ task_info.status }}</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="row text-muted small mb-2">
                                        <div class="col-md-6">
                                            <i class="fas fa-clock me-1"></i>
                                            上传时间: {{ task_info.upload_time[:19] if task_info.upload_time else '未知' }}
                                        </div>
                                        <div class="col-md-6">
                                            <i class="fas fa-microchip me-1"></i>
                                            设备: {{ task_info.options.device if task_info.options else 'CPU' }}
                                        </div>
                                    </div>
                                    
                                    <p class="card-text text-muted mb-0">
                                        {{ task_info.message }}
                                    </p>
                                </div>
                                
                                <div class="col-md-4 text-end">
                                    {% if task_info.status == 'completed' %}
                                        <a href="/results/{{ task_id }}" class="btn btn-sm btn-primary me-2">
                                            <i class="fas fa-eye me-1"></i>查看结果
                                        </a>
                                        <a href="/download/{{ task_id }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-download me-1"></i>下载
                                        </a>
                                    {% elif task_info.status == 'processing' %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="checkStatus('{{ task_id }}')">
                                            <i class="fas fa-sync-alt me-1"></i>检查状态
                                        </button>
                                    {% elif task_info.status == 'error' %}
                                        <span class="text-danger small">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            处理失败
                                        </span>
                                    {% endif %}
                                    
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            任务ID: {{ task_id[:8] }}...
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- 空状态 -->
            <div class="empty-state">
                <i class="fas fa-folder-open fa-4x mb-4"></i>
                <h4>还没有历史记录</h4>
                <p class="mb-4">开始上传您的第一个PDF文件来进行化学信息提取吧！</p>
                <a href="/" class="btn btn-primary btn-lg">
                    <i class="fas fa-upload me-2"></i>
                    立即开始
                </a>
            </div>
        {% endif %}
    </div>

    <!-- 状态检查模态框 -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">任务状态</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statusModalBody">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">检查中...</span>
                        </div>
                        <p class="mt-2">正在检查任务状态...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        async function checkStatus(taskId) {
            const modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
            
            try {
                const response = await fetch(`/status/${taskId}`);
                const status = await response.json();
                
                if (response.ok) {
                    let content = `
                        <div class="row">
                            <div class="col-6">
                                <strong>状态:</strong>
                            </div>
                            <div class="col-6">
                                ${getStatusBadge(status.status)}
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>消息:</strong>
                            </div>
                            <div class="col-6">
                                ${status.message}
                            </div>
                        </div>
                    `;
                    
                    if (status.summary) {
                        content += `
                            <hr>
                            <h6>提取结果概览:</h6>
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="h5 text-primary">${status.summary.molecules}</div>
                                    <small>分子</small>
                                </div>
                                <div class="col-3">
                                    <div class="h5 text-success">${status.summary.reactions}</div>
                                    <small>反应</small>
                                </div>
                                <div class="col-3">
                                    <div class="h5 text-warning">${status.summary.figures}</div>
                                    <small>图片</small>
                                </div>
                                <div class="col-3">
                                    <div class="h5 text-info">${status.summary.tables}</div>
                                    <small>表格</small>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('statusModalBody').innerHTML = content;
                    
                    // 如果状态已改变，刷新页面
                    if (status.status === 'completed' || status.status === 'error') {
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                } else {
                    throw new Error(status.error || '获取状态失败');
                }
            } catch (error) {
                document.getElementById('statusModalBody').innerHTML = `
                    <div class="text-danger text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>获取状态失败: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function getStatusBadge(status) {
            const badges = {
                'completed': '<span class="badge bg-success">已完成</span>',
                'processing': '<span class="badge bg-primary">处理中</span>',
                'pending': '<span class="badge bg-info">等待中</span>',
                'error': '<span class="badge bg-danger">出错</span>'
            };
            return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
        }
        
        async function clearHistory() {
            if (confirm('确定要清理历史记录吗？这将删除超过24小时的旧任务及其文件。')) {
                try {
                    const response = await fetch('/cleanup');
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        throw new Error(result.error || '清理失败');
                    }
                } catch (error) {
                    alert('清理失败: ' + error.message);
                }
            }
        }
    </script>
</body>
</html> 